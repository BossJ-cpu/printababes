# Changelog - January 26, 2026

## Summary
Added image upload feature for e-signatures/stamps in the PDF Template Editor, allowing users to upload, position, resize, and embed images directly into generated PDFs.

---

## Features Added

### 1. Image Upload for E-Signatures
**Purpose:** Allow users to upload images (signatures, stamps, logos) that get embedded in generated PDFs.

#### Frontend Changes

**File: `rebuild-copies/next-frontend/app/pdf-editor/page.tsx`**

- Added `ImageConfig` type definition:
  ```typescript
  type ImageConfig = {
    x: number;      // X position in mm
    y: number;      // Y position in mm
    width: number;  // Width in mm
    height: number; // Height in mm
    page: number;   // Page number
    dataUrl: string; // Base64 encoded image
    name: string;   // Original filename
  };
  ```

- Added `images_config` to `TemplateConfig` type

- Added state variables:
  - `uploadedImages` - Stores all uploaded images
  - `selectedImageKey` - Currently selected image
  - `imageInputRef` - Reference to file input

- Added handler functions:
  - `handleImageUpload` - Validates file type/size (max 2MB), converts to base64, calculates dimensions
  - `handleImagePositionUpdate` - Updates image position when dragged
  - `handleImagePropertyChange` - Updates image width/height/page
  - `handleRemoveImage` - Removes an image from the template

- Added image upload UI section with:
  - File input accepting PNG, JPG, GIF
  - List of uploaded images with thumbnails
  - Position and size display

- Updated `handleSave` to include `images_config` in API call

- Added keyboard navigation for images (arrow keys to move, same as fields)

- Images are cleared when:
  - Creating new template
  - Deleting template
  - Switching templates

**File: `rebuild-copies/next-frontend/app/pdf-editor/PDFViewer.tsx`**

- Added `ImageConfig` type to props interface

- Added new props:
  - `images` - Record of uploaded images
  - `onImagePositionUpdate` - Callback for position changes
  - `onImagePropertyChange` - Callback for property changes
  - `onRemoveImage` - Callback for removal
  - `selectedImageKey` - Currently selected image key
  - `onSelectImage` - Callback for selection

- Added `data-pdf-page` attribute to page containers for resize handle targeting

- Added image markers rendering with:
  - Visual display of uploaded images at correct position/size
  - Draggable support for repositioning via drag-drop
  - Selection highlighting (green border when selected)
  - Image label showing filename

- Added remove button:
  - Red circular button at top-right corner
  - Confirmation dialog before removal
  - High z-index (100) to ensure clickability
  - White border for visibility

- Added resize handles (visible when image is selected):
  - **Bottom-right corner handle** - Resize both width and height (hold Shift for proportional)
  - **Right edge handle** - Resize width only
  - **Bottom edge handle** - Resize height only
  - All handles:
    - `draggable={false}` to prevent drag interference
    - `onDragStart` prevention
    - Temporarily disable parent draggable during resize
    - Use `document.querySelector` for reliable container lookup
    - `touchAction: 'none'` for touch device support
    - z-index 200 for proper layering

- Updated `onDrop` handler to detect and handle image movement:
  ```javascript
  const dragType = e.dataTransfer.getData('type');
  const imageKey = e.dataTransfer.getData('imageKey');
  if (dragType === 'moveImage' && imageKey && onImagePositionUpdate) {
    // Calculate mm position and update
  }
  ```

#### Backend Changes

**File: `database/migrations/2026_01_27_000001_add_images_config_to_pdf_templates.php`**
- New migration adding `images_config` TEXT column to `pdf_templates` table

**File: `app/Models/PdfTemplate.php`**
- Added `images_config` to `$fillable` array
- Added `images_config` to `$casts` array as `'array'`

**File: `app/Http/Controllers/PdfTemplateController.php`**

- Updated `update()` method to save `images_config`

- Updated `preview()` method to render images:
  - Loops through `images_config` for each page
  - Extracts base64 data from dataUrl
  - Creates temporary file with correct extension
  - Uses FPDF's `Image()` method to embed in PDF
  - Cleans up temp file after rendering

- Updated `generateBulk()` method with same image rendering logic:
  - Images appear on every generated PDF in the batch
  - Same temp file approach for reliability

---

## Bug Fixes

### 1. Resize Handles Not Working
**Problem:** Dragging resize handles would either create a new field or move the entire image instead of resizing.

**Solution:**
- Added `draggable={false}` to resize handle elements
- Added `onDragStart={(e) => e.preventDefault()}` 
- Temporarily set parent's `draggable` attribute to `'false'` during resize operation
- Re-enable parent draggable on mouse up
- Changed from `closest()` to `document.querySelector()` for reliable container lookup

### 2. Remove Button Improvements
**Problem:** Remove button was small and hard to click.

**Solution:**
- Increased button size to 22x22px
- Added white border for visibility
- Added confirmation dialog
- Increased z-index to 100
- Added `e.preventDefault()` to event handler

---

## Keyboard Navigation

### Image Movement via Arrow Keys
- **Arrow keys** - Move selected image by ~1.3mm
- **Shift + Arrow keys** - Move selected image by ~2.6mm (larger steps)
- Works for both fields and images (whichever is selected)

---

## Git Commit

**Branch:** `Printababes-v2.0.1`

**Commit:** `f1b6bb2`

**Message:**
```
Add image upload feature for e-signatures in PDF editor

- Add ImageConfig type and images_config to template
- Add image upload UI with file validation (2MB max, PNG/JPG/GIF)
- Add image markers in PDFViewer with drag-to-position support
- Add resize handles (corner, right edge, bottom edge) for images
- Add keyboard navigation (arrow keys) for images like fields
- Add remove button with confirmation for images
- Add images_config column migration to pdf_templates table
- Update PdfTemplate model with images_config fillable and cast
- Update controller to save and render images in PDF generation
- Images rendered in both preview and bulk generation
```

---

## Files Modified

| File | Type | Changes |
|------|------|---------|
| `rebuild-copies/next-frontend/app/pdf-editor/page.tsx` | Modified | Image upload UI, handlers, keyboard nav |
| `rebuild-copies/next-frontend/app/pdf-editor/PDFViewer.tsx` | Modified | Image markers, resize handles, drag-drop |
| `app/Http/Controllers/PdfTemplateController.php` | Modified | Save & render images in PDF |
| `app/Models/PdfTemplate.php` | Modified | Added images_config to fillable/casts |
| `database/migrations/2026_01_27_000001_add_images_config_to_pdf_templates.php` | New | Migration for images_config column |
| `.gitignore` | Modified | Added 'nul' to ignore list |

---

## How to Use

1. **Upload an Image:**
   - In the PDF editor sidebar, find the "Upload Image/Signature" section
   - Click "Choose File" and select a PNG, JPG, or GIF (max 2MB)
   - Image will appear in the uploaded images list

2. **Position the Image:**
   - Drag the image from the list onto the PDF preview
   - Or use arrow keys to fine-tune position after selecting

3. **Resize the Image:**
   - Click the image to select it (green border appears)
   - Drag the green handles:
     - Corner handle: resize both dimensions
     - Right handle: resize width
     - Bottom handle: resize height
   - Hold Shift while dragging corner for proportional resize

4. **Remove an Image:**
   - Click the red Ã— button on the image
   - Confirm removal in the dialog

5. **Save Template:**
   - Click "Save Template" to persist images with the template
   - Images will appear in all generated PDFs

---

## Database Migration

Run migration if not already done:
```bash
php artisan migrate
```

This adds the `images_config` column to store image data as JSON.
