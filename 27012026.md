# Changes Log - January 27, 2026

## Issues Fixed

### 1. XLSX File Upload Showing Garbled/Random Column Names

**Problem:**  
When uploading Excel files (`.xlsx`, `.xls`), the "Available Columns from CSV/Excel" section displayed random gibberish characters instead of the actual column headers. This happened because the code was using `file.text()` to read the file contents, which only works for text-based CSV files. Excel files are binary ZIP archives containing XML data, so reading them as text produces garbage output.

**Solution:**  
- Added the `xlsx` (SheetJS) library to properly parse Excel binary files
- Updated `handleCsvUpload` function to detect file type by extension
- For `.csv` files: continues using text parsing
- For `.xlsx`/`.xls` files: uses `XLSX.read()` with `arrayBuffer` to properly parse the binary format

**Files Modified:**
- `rebuild-copies/next-frontend/package.json` - Added xlsx dependency
- `rebuild-copies/next-frontend/app/pdf-editor/page.tsx` - Updated import and parsing logic

**Code Changes:**

Added import:
```tsx
import * as XLSX from 'xlsx';
```

Updated `handleCsvUpload` function to handle both CSV and Excel files:
```tsx
const handleCsvUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
  // ... validation code ...
  
  const fileExtension = file.name.split('.').pop()?.toLowerCase();
  
  if (fileExtension === 'csv') {
    // Parse CSV file using text()
    const text = await file.text();
    // ... CSV parsing logic ...
  } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
    // Parse Excel file using xlsx library
    const arrayBuffer = await file.arrayBuffer();
    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
    const firstSheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[firstSheetName];
    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
    // ... Excel parsing logic ...
  }
};
```

---

### 2. Remove Button Not Working for CSV/Excel Imports

**Problem:**  
After uploading a CSV or Excel file, clicking the "Remove" button did nothing. The file remained loaded and couldn't be cleared.

**Root Cause:**  
The `handleRemoveCsvImport` function had a guard condition:
```tsx
if (!template.id || !csvImport) return;
```

This required `template.id` to exist, but when a file is loaded locally (before saving the template to the backend), there is no `template.id` yet. The function would exit early without doing anything.

**Solution:**  
Changed the logic to:
1. Only check if `csvImport` exists (not `template.id`)
2. Attempt server delete only if `template.id` exists
3. Always clear local state regardless of server response

**Updated Code:**
```tsx
const handleRemoveCsvImport = async () => {
  if (!csvImport) return;

  // If template has been saved to backend, also delete from server
  if (template.id) {
    try {
      const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/templates/${template.id}/import`, {
        method: 'DELETE',
        headers: { /* ... */ }
      });

      if (!res.ok) {
        console.warn('Server delete failed, but will clear local state anyway');
      }
    } catch (error) {
      console.warn('Server delete error:', error);
      // Continue to clear local state even if server delete fails
    }
  }

  // Always clear local state
  setCsvImport(null);
  setCsvColumns([]);
  showNotif('CSV/Excel import removed', 'success');
};
```

---

## New Features Added

### 3. Draw Signature Feature

**Description:**  
Added the ability to draw signatures directly in the PDF editor using a canvas-based popup modal. Users can hand-draw signatures with their mouse or touchscreen.

**Features:**
- Canvas-based drawing with smooth line rendering
- Adjustable pen thickness (1-8 pixels)
- Undo last stroke functionality
- Clear all strokes button
- Save signature to place on PDF
- Signatures are treated like uploaded images (can be positioned, resized, moved)

**Files Modified:**
- `rebuild-copies/next-frontend/app/pdf-editor/page.tsx` - Added signature modal, canvas drawing logic, and state management

**New State Variables:**
```tsx
const [showSignatureModal, setShowSignatureModal] = useState(false);
const [signatureStrokes, setSignatureStrokes] = useState<{x: number, y: number}[][]>([]);
const [isDrawing, setIsDrawing] = useState(false);
const [penThickness, setPenThickness] = useState(2);
```

**Key Functions:**
- `openSignatureModal()` - Opens the signature drawing modal
- `closeSignatureModal()` - Closes and resets the modal
- `startDrawing()` - Begins a new stroke on mouse/touch down
- `draw()` - Continues the stroke on mouse/touch move
- `stopDrawing()` - Ends the current stroke
- `clearSignature()` - Clears all strokes from the canvas
- `undoLastStroke()` - Removes the last drawn stroke
- `saveSignature()` - Converts canvas to image and adds to PDF

---

### 4. Record Range Selection for Images/Signatures

**Description:**  
Added the ability to apply images and signatures to only specific records during bulk PDF generation. This allows different signatures or stamps to appear on different record ranges.

**Use Case Example:**  
- Signature A appears on records 1-50
- Signature B appears on records 51-100
- A stamp appears only on record 75

**Range Format:**
- Single record: `15`
- Range of records: `1-10`
- Multiple ranges: `1-10, 15, 20-25`
- Empty = applies to ALL records (default)

**Frontend Changes:**
- Added `recordRange` field to `ImageConfig` type
- Record range input in the signature drawing modal
- Record range input for each image in the uploaded images list
- Visual indicator showing which records each image applies to

**Backend Changes:**
- Added `isRecordInRange()` helper method to `PdfTemplateController`
- Modified `generateBulk()` to check `recordRange` before adding each image
- Images are skipped for records not in their specified range

**Files Modified:**
- `rebuild-copies/next-frontend/app/pdf-editor/page.tsx` - Added recordRange to ImageConfig type and UI inputs
- `app/Http/Controllers/PdfTemplateController.php` - Added range checking logic and helper method

**New PHP Helper Method:**
```php
/**
 * Check if a record number is within the specified range string
 * Range format: "1-10, 15, 20-25" (comma-separated ranges and single values)
 */
private function isRecordInRange(int $recordNumber, string $rangeString): bool
{
    // Empty range means all records
    if (empty(trim($rangeString))) {
        return true;
    }
    
    // Parse and check ranges...
}
```

---

## Dependencies Added

| Package | Version | Purpose |
|---------|---------|---------|
| xlsx | ^0.18.5 | Parse Excel files (.xlsx, .xls) |

---

## How to Apply Changes

After pulling these changes, run:

```bash
cd rebuild-copies/next-frontend
npm install
npm run dev
```

---

## Testing Checklist

- [x] Upload `.csv` file → columns display correctly
- [x] Upload `.xlsx` file → columns display correctly  
- [x] Upload `.xls` file → columns display correctly
- [x] Click "Remove" button on locally loaded file → file is cleared
- [x] Click "Remove" button on saved template's import → file is cleared from both local and server
- [ ] Click "Draw Signature" button → modal opens with canvas
- [ ] Draw on canvas → signature strokes appear
- [ ] Adjust pen thickness → line width changes
- [ ] Click "Undo" → last stroke is removed
- [ ] Click "Clear" → all strokes are cleared
- [ ] Click "Save Signature" → signature appears on PDF
- [ ] Set record range on signature → only applies to specified records in bulk generation
- [ ] Set record range on uploaded image → only applies to specified records in bulk generation
- [ ] Leave record range empty → image/signature applies to all records
