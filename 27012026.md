# Changes Log - January 27, 2026

## Issues Fixed

### 1. XLSX File Upload Showing Garbled/Random Column Names

**Problem:**  
When uploading Excel files (`.xlsx`, `.xls`), the "Available Columns from CSV/Excel" section displayed random gibberish characters instead of the actual column headers. This happened because the code was using `file.text()` to read the file contents, which only works for text-based CSV files. Excel files are binary ZIP archives containing XML data, so reading them as text produces garbage output.

**Solution:**  
- Added the `xlsx` (SheetJS) library to properly parse Excel binary files
- Updated `handleCsvUpload` function to detect file type by extension
- For `.csv` files: continues using text parsing
- For `.xlsx`/`.xls` files: uses `XLSX.read()` with `arrayBuffer` to properly parse the binary format

**Files Modified:**
- `rebuild-copies/next-frontend/package.json` - Added xlsx dependency
- `rebuild-copies/next-frontend/app/pdf-editor/page.tsx` - Updated import and parsing logic

**Code Changes:**

Added import:
```tsx
import * as XLSX from 'xlsx';
```

Updated `handleCsvUpload` function to handle both CSV and Excel files:
```tsx
const handleCsvUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
  // ... validation code ...
  
  const fileExtension = file.name.split('.').pop()?.toLowerCase();
  
  if (fileExtension === 'csv') {
    // Parse CSV file using text()
    const text = await file.text();
    // ... CSV parsing logic ...
  } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
    // Parse Excel file using xlsx library
    const arrayBuffer = await file.arrayBuffer();
    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
    const firstSheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[firstSheetName];
    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
    // ... Excel parsing logic ...
  }
};
```

---

### 2. Remove Button Not Working for CSV/Excel Imports

**Problem:**  
After uploading a CSV or Excel file, clicking the "Remove" button did nothing. The file remained loaded and couldn't be cleared.

**Root Cause:**  
The `handleRemoveCsvImport` function had a guard condition:
```tsx
if (!template.id || !csvImport) return;
```

This required `template.id` to exist, but when a file is loaded locally (before saving the template to the backend), there is no `template.id` yet. The function would exit early without doing anything.

**Solution:**  
Changed the logic to:
1. Only check if `csvImport` exists (not `template.id`)
2. Attempt server delete only if `template.id` exists
3. Always clear local state regardless of server response

**Updated Code:**
```tsx
const handleRemoveCsvImport = async () => {
  if (!csvImport) return;

  // If template has been saved to backend, also delete from server
  if (template.id) {
    try {
      const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/templates/${template.id}/import`, {
        method: 'DELETE',
        headers: { /* ... */ }
      });

      if (!res.ok) {
        console.warn('Server delete failed, but will clear local state anyway');
      }
    } catch (error) {
      console.warn('Server delete error:', error);
      // Continue to clear local state even if server delete fails
    }
  }

  // Always clear local state
  setCsvImport(null);
  setCsvColumns([]);
  showNotif('CSV/Excel import removed', 'success');
};
```

---

## Dependencies Added

| Package | Version | Purpose |
|---------|---------|---------|
| xlsx | ^0.18.5 | Parse Excel files (.xlsx, .xls) |

---

## How to Apply Changes

After pulling these changes, run:

```bash
cd rebuild-copies/next-frontend
npm install
npm run dev
```

---

## Testing Checklist

- [x] Upload `.csv` file → columns display correctly
- [x] Upload `.xlsx` file → columns display correctly  
- [x] Upload `.xls` file → columns display correctly
- [x] Click "Remove" button on locally loaded file → file is cleared
- [x] Click "Remove" button on saved template's import → file is cleared from both local and server
